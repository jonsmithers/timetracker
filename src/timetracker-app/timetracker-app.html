<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="./time-log.html">
<script src="../../bower_components/moment/moment.js"></script>
<script src="../../bower_components/moment-duration-format/lib/moment-duration-format.js"></script>

<dom-module id="timetracker-app">
  <template>
    <style>
      :host {
        display: block;
      }
      .verticalLayoutContainer {
        height: 100%;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
      }
      .flexGrow {
        flex-grow: 1;
      }
      div#durationDisplay {
        padding: 20px;
        text-align: center;
        font-size: 30px;
        font-family: monospace;
      }
      iron-pages, iron-pages > * {
        height: 100%;
      }
    </style>
    <paper-drawer-panel id="drawer">
      <div drawer>
        <paper-toolbar class="tall">
        </paper-toolbar>
        <paper-item on-tap="_onDrawerItemTap" page-name="timer">Timer</paper-item>
        <paper-item on-tap="_onDrawerItemTap" page-name="log">Log</paper-item>
        <paper-item on-tap="_onDrawerItemTap" page-name="settings">Settings</paper-item>
      </div>
      <paper-header-panel main>
        <paper-toolbar>
          <paper-icon-button icon="menu" on-tap="_onHamburgerTap"></paper-icon-button>
          <div class="title">Time Log</div>
        </paper-toolbar>
        <iron-pages id="ironPages" attr-for-selected="page-name" selected="timer">
          <div page-name="timer">
            <div id="durationDisplay">[[durationDisplay]]</div>
            <div>
              <paper-button raised on-tap="_onStartTap" hidden="[[startTime]]">start</paper-button>
              <paper-button raised on-tap="_onStopTap" hidden="[[!startTime]]">stop</paper-button>
            </div>
          </div>
          <time-log page-name="log" time-log="[[timeLog]]"></time-log>
          <div page-name="settings">
            <paper-button raised on-tap="_onResetTap" style="background-color:red">reset</paper-button>
          </div>
        </iron-pages>
      </paper-header-panel>
    </paper-drawer-panel>



    <!-- invisible stuff -->
    <paper-dialog id="welcomeDialog">
      <h2>Welcome</h2>
      <div>This is you're first time here. Coooool.</div>
      <div class="buttons">
        <paper-button dialog-dismiss>yeah</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="confirmResetDialog">
      <h2>
        Erase all data?
      </h2>
      <div>dangeah dangeah</div>
      <div class="buttons">
        <paper-button dialog-dismiss on-tap="_clearStorage">do it</paper-button>
        <paper-button dialog-dismiss>noo</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    /**
     * @param {Moment} startTime
     * @param {Moment} [endTime] - defaults to "now"
     * @return {Duration} duration
     */
    const getTimeDuration = function(fromTime, toTime) {
      toTime = toTime || moment();
      var diffInMilliseconds = toTime.diff(fromTime, "milliseconds");
      var duration = moment.duration(diffInMilliseconds, "milliseconds");
      return duration;
    };

    (function() {

      const storage_label = "timetracker-data";


      Polymer({

        is: 'timetracker-app',

        properties: {
          startTime:       Object,
          durationDisplay: String,
          timeLog:         Array,
        },
        observers: [
          "_saveToStorage(startTime, timeLog)",
          "_onStartTimeSet(startTime)"
        ],

        ready: function() {
          this._loadFromStorage();
        },

        _loadFromStorage: function() {
          // make sure storage is initialized
          if (!localStorage.getItem(storage_label)) {
            this.$.welcomeDialog.open();
            localStorage.setItem(storage_label, JSON.stringify({
              timeLog: [],
              startTime: null
            }));
          }

          var data = JSON.parse(localStorage.getItem(storage_label));
          this.timeLog = data.timeLog;
          this.startTime = data.startTime ? moment.unix(data.startTime) : null;
        },
        _saveToStorage: function() {
          localStorage.setItem(storage_label, JSON.stringify({
            timeLog: this.timeLog,
            startTime: (this.startTime ? this.startTime.unix() : null)
          }));
        },
        _onResetTap: function() {
          this.$.confirmResetDialog.open();
        },
        _clearStorage: function() {
          this.startTime = null;
          localStorage.removeItem(storage_label);
          this._loadFromStorage();
        },
        _onStartTimeSet: function() {
          console.trace("_onStartTimeSet() (debounced)");
          this.debounce("darnit zepto.min.js", function() {
            if (this.startTime) {
              this._interval = setInterval(function() {
                this.durationDisplay = getTimeDuration(this.startTime).format("h:mm:ss");
              }.bind(this), 1000);
            } else {
              clearInterval(this._interval);
              this.durationDisplay = "0";
            }
          }.bind(this), 100);
        },
        _onStartTap: function() {
          this.startTime = moment();
        },
        _onStopTap: function() {
          console.trace("_onStopTap() (debounced)");
          this.debounce("where did zepto come from?", function() {
            var startTime = this.startTime;
            var stopTime  = moment();
            this.startTime = null;

            // var duration = getTimeDuration(startTime, stopTime);
            this.push("timeLog", {
              startTime: startTime.unix(),
              stopTime: stopTime.unix(),
              // duration: duration
            });
          }.bind(this), 100);
        },
        _onHamburgerTap: function() {
          this.$.drawer.openDrawer();
        },
        _onDrawerItemTap: function(e) {
          var pageName = e.srcElement.getAttribute("page-name");
          this.$.ironPages.selected = pageName;
          this.$.drawer.closeDrawer();
        },
      });
    })();
  </script>
</dom-module>
